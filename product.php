<!DOCTYPE html>
<html>
  <?php
  session_start();
  ?>
<head>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="globals.css" />
    <link rel="stylesheet" href="styleguide.css" />
    <link rel="stylesheet" href="style.css" />
    <link rel="styleSheet" href="product.css">
    <link rel="stylesheet" href="product1.css">
    <!-- Include Swiper's CSS -->
    <link rel="stylesheet" href="https://unpkg.com/swiper/swiper-bundle.min.css" />
</head>
<body>
<div class="product-detail-page">
      <div class="div">
        <div class="overlap">
          <div class="overlap-group">
            <img class="element" src="img/img-0307007636lpk-1ladies-t-shirt-fashion-bug-srilanka-compresse.png" />
            <img class="element-blu" src="img/img-0203209940lgr-1-mens-plain-t-shirt-fashion-bug-sri-lanka-1.png" />
            <div class="rectangle"></div>
            <div class="frame">
              <img class="element-lpk" src="img/img-0307007636lpk-1ladies-t-shirt-fashion-bug-srilanka-compressed-3.png" />
            </div>
            <div class="task-baar">
              <div class="overlap-2">
                <div class="frame-2">
                  <div class="navbar">
                    <div class="text-wrapper">Shop</div>
                    <div class="text-wrapper">Men</div>
                    <div class="text-wrapper">Women</div>
                    <div class="text-wrapper-2">Kids</div>
                  </div>
                  <button class="button">
                    <img class="img" src="img/img-search.svg" /> <button class="button-2">Search</button>
                  </button>
                  <div class="frame-3">
                    <div class="component"><img class="img" src="img/img-heart-2.svg" /></div>
                    <div class="component"><img class="img" src="img/img-heart.svg" /></div>
                    <div class="shopping-cart-wrapper"><img class="img" src="img/img-shopping-cart.svg" /></div>
                  </div>
                </div>
                <div class="rectangle-2"></div>
                <img class="images" src="img/img-images-1-1.png" />
              </div>
            </div>
            <img
              class="moose-pant-moss"
              src="img/img-moose-pant-moss-stone-1mens-chino-pant-fashion-bug-srilanka-compressed-1.png"
            />
          </div>
          <img class="element-mens" src="img/img-0203211176bk-1-mens-t-shirt-fashion-bug-sri-lanka-1.png" />
          <div class="frame-4">
            <div class="text-wrapper-3">Shop</div>
            <img class="left-stroke" src="img/img-left-stroke.svg" />
            <div class="text-wrapper-3">Women</div>
            <img class="left-stroke" src="img/imgleft-stroke.svg" />
            <div class="text-wrapper-3">Top</div>
          </div>
          <div class="text-wrapper-4">Light Pink T-Shirt</div>
          <div class="frame-5">
            <div class="frame-6">
              <div class="frame-7">
                <div class="star"><img class="star-2" src="img/img-star-2.svg" /></div>
                <div class="star"><img class="star-2" src="img/img-star-2.svg" /></div>
                <div class="star"><img class="star-2" src="img/img-star-2.svg" /></div>
                <div class="star"><img class="star-2" src="img/img-star-2.svg" /></div>
                <div class="star"><img class="star-2" src="img/img-star-2.svg" /></div>
              </div>
              <div class="text-wrapper-5">3.5</div>
            </div>
            <div class="frame-8">
              <img class="message-icon" src="img/img-icon-2.svg" />
              <div class="text-wrapper-5">120 Reviews</div>
            </div>
          </div>
          <div class="frame-9">
            <div class="frame-10">
              <div class="text-wrapper-6">Select Size</div>
              <div class="frame-11">
                <div class="text-wrapper-3">Size Guide</div>
                <img class="arrow" src="img/img-arrow.svg" />
              </div>
            </div>
            <div class="frame-12">
              <div class="size">
                <div class="div-wrapper"><div class="text-wrapper-7">XS</div></div>
              </div>
              <div class="size">
                <div class="div-wrapper"><div class="text-wrapper-7">S</div></div>
              </div>
              <div class="size">
                <div class="div-wrapper"><div class="text-wrapper-7">M</div></div>
              </div>
              <div class="size">
                <div class="s-wrapper"><div class="s">L</div></div>
              </div>
              <div class="size">
                <div class="div-wrapper"><div class="text-wrapper-7">XL</div></div>
              </div>
            </div>
          </div>
          <div class="frame-13">
            <div class="text-wrapper-6">Colours Available</div>
            <div class="frame-14">
              <div class="colour">
                <div class="overlap-group-2">
                  <div class="ellipse"></div>
                  <div class="ellipse-2"></div>
                </div>
              </div>
              <div class="colour-2"></div>
              <div class="colour-3"></div>
              <div class="colour-4"></div>
            </div>
          </div>
          <div class="frame-15">
            <div class="img-wrapper"><img class="credit-card" src="img/img-credit-card.svg" /></div>
            <div class="text-wrapper-8">Secure payment</div>
          </div>
          <div class="frame-16">
            <div class="img-wrapper"><img class="truck" src="img/img-truck.svg" /></div>
            <div class="text-wrapper-8">Free shipping</div>
          </div>
          <div class="frame-17">
            <div class="text-wrapper-8">Free Shipping &amp; Returns</div>
            <div class="img-wrapper"><img class="img-2" src="img/img-free-shipping-returns.svg" /></div>
          </div>
          <div class="frame-18">
            <div class="text-wrapper-8">Size &amp; Fit</div>
            <div class="img-wrapper"><img class="img-2" src="img/img-size-fit.svg" /></div>
          </div>
        </div>
        <img class="element-pgr" src="img/img-0310104021pgr-2-1.png" />
        <img class="element-lgr-mens" src="img/img-0203209940lgr-1-mens-plain-t-shirt-fashion-bug-sri-lanka-1.png" />
        <img
          class="element-moose"
          src="img/img-0203211108scl-moose-mens-short-sleeve-crew-neck-t-shirt-fashion-bug-srilanka-compressed-1.png"
        />
        <img class="line" src="img/img-line-1.svg" />
        <div class="product-description">
          <div class="text-wrapper-9">Product Description</div>
          <div class="rectangle-3"></div>
        </div>
        <div class="description">
          <p class="element-bio-washed">
            100% Bio-washed Cotton – makes the fabric extra soft &amp; silky. Flexible ribbed crew neck. Precisely
            stitched with no pilling &amp; no fading. Provide&nbsp;&nbsp;all-time comfort. Anytime, anywhere. Infinite
            range of matte-finish HD prints.
          </p>
          <div class="frame-21">
            <div class="text-wrapper-10">Description</div>
            <div class="frame-22">
              <div class="text-wrapper-11">Reviws</div>
              <div class="frame-23"><div class="text-wrapper-12">21</div></div>
            </div>
            <div class="frame-24">
              <div class="question-answer">Question &amp; Answer</div>
              <div class="frame-25"><div class="text-wrapper-12">4</div></div>
            </div>
            <img class="line-2" src="img/img-line-2.svg" />
          </div>
        </div>
        <div class="product-tabel">
          <div class="overlap-3">
            <div class="rectangle-4"></div>
            <img class="line-3" src="img/img-line-3.svg" />
            <div class="frame-26">
              <img class="line-4" src="img/img-line-5.svg" />
              <img class="line-5" src="img/img-line-5.svg" />
              <div class="frame-27">
                <div class="text-wrapper-13">Fabric</div>
                <div class="text-wrapper-14">Bio-washed Cotton</div>
              </div>
              <div class="frame-28">
                <div class="text-wrapper-13">Pattern</div>
                <div class="text-wrapper-14">Printed</div>
              </div>
              <div class="frame-29">
                <div class="text-wrapper-13">Fit</div>
                <div class="text-wrapper-14">Regular-fit</div>
              </div>
              <div class="frame-30">
                <div class="text-wrapper-13">Neck</div>
                <div class="text-wrapper-14">Round Neck</div>
              </div>
              <div class="frame-31">
                <div class="text-wrapper-13">Sleeve</div>
                <div class="text-wrapper-14">Half-sleeves</div>
              </div>
              <div class="frame-32">
                <div class="text-wrapper-13">Style</div>
                <div class="text-wrapper-14">Casual Wear</div>
              </div>
            </div>
          </div>
        </div>
        <img class="element-3" src="img/img-0307007636lpk-1ladies-t-shirt-fashion-bug-srilanka-compressed-3.png" />
        <img class="element-4" src="img/img-0307007636lpk-2ladies-t-shirt-fashion-bug-srilanka-compressed-3-1.png" />
        <div class="need-help-section">
          <div class="frame-34">
            <img class="icon" src="img/img-icon.svg" />
            <div class="frame-35">
              <div class="frame-36">
                <div class="text-wrapper-16">Location</div>
                <div class="frame-37">
                  <p class="p">No. 24, Negambo Road, Ragama</p>
                  <div class="text-wrapper-17">No. 62, Palawaththa, Baththaramulla</div>
                </div>
              </div>
              <div class="frame-38">
                <div class="text-wrapper-16">More Info</div>
                <div class="frame-39">
                  <div class="text-wrapper-18">Term and Conditions</div>
                  <div class="text-wrapper-19">Privacy Policy</div>
                  <div class="text-wrapper-20">Shipping Policy</div>
                  <div class="text-wrapper-21">Sitemap</div>
                </div>
              </div>
              <div class="frame-40">
                <div class="text-wrapper-16">Need Help</div>
                <div class="frame-41">
                  <div class="text-wrapper-18">Contact Us</div>
                  <div class="text-wrapper-19">Track Order</div>
                  <div class="text-wrapper-20">Returns &amp; Refunds</div>
                  <div class="text-wrapper-21">FAQ&#39;s</div>
                  <div class="text-wrapper-22">Career</div>
                </div>
              </div>
              <div class="frame-42">
                <div class="text-wrapper-16">Company</div>
                <div class="frame-43">
                  <div class="text-wrapper-18">About Us</div>
                  <div class="text-wrapper-19">euphoria Blog</div>
                  <div class="text-wrapper-20">euphoriastan</div>
                  <div class="text-wrapper-21">Collaboration</div>
                  <div class="text-wrapper-22">Media</div>
                </div>
              </div>
            </div>
            <div class="text-wrapper-23">Popular Categories</div>
            <div class="frame-44">
              <div class="group"><img class="vector" src="img/img-vector-2.svg" /></div>
              <div class="group"><img class="vector-2" src="img/img-vector.svg" /></div>
              <div class="group"><img class="vector-3" src="img/img-vector-3.svg" /></div>
              <div class="overlap-group-wrapper">
                <div class="overlap-group-3"><div class="text-wrapper-24">in</div></div>
              </div>
            </div>
            <img class="line-6" src="img/img-line-6.svg" />
            <img class="line-7" src="img/img-line-6.svg" />
            <p class="text-wrapper-25">Copyright © 2024 Beliyo Fasion Pvt Ltd. All rights reserved.</p>
          </div>
        </div>
        <img class="element-men" src="img/img-0203211581blu-1-men-t-shirt-fashion-bug-sri-lanka-1.png" />
      </div>
    </div>
    <div class="product-container">
        <?php
        // Connect to the database
        $servername = "localhost:3307";
        $username = "root";
        $password = "";
        $dbname = "storedb";

        $conn = new mysqli($servername, $username, $password, $dbname);

        if ($conn->connect_error) {
            die("Connection failed: " . $conn->connect_error);
        }

        // Get the product ID from the URL
        $productId = isset($_GET['id']) ? intval($_GET['id']) : 0;

        // Query to get product data and images
        $sql = "
        SELECT 
            productName AS name,
            price
        FROM 
            product 
        WHERE 
            productID = $productId
        ";

        $result = $conn->query($sql);

        if ($result->num_rows > 0) {
            // Prepare for display
            $product = $result->fetch_assoc();
            $productName = htmlspecialchars($product['name']);
            $productPrice = htmlspecialchars($product['price']);

            $imagePaths = [];

            $sql = "
            SELECT
              name
            FROM
              image
            WHERE
              productID = $productId
            ";
            
            $result = $conn->query($sql);

            // Reset the query for images
            $result->data_seek(0);
            while ($imagePath = $result->fetch_assoc()) {
              $imagePaths[] = 'productImages/' . htmlspecialchars($imagePath['name']);
            }
            
            echo '
                  <div class="other-images">';

            foreach($imagePaths as $imagePath) {
              echo '<img class="other-image" src="' . $imagePath . '" onclick="changeImage(this.src)">';
            }

            echo '</div>
                  <div class="product-image">
                    <img class="image" src="' . (!empty($imagePaths) ? $imagePaths[0] : 'defaultImagePath.jpg') . '">
                  </div>
                  <div class="product-details">
                    <h1 class="product-title">'
                        . $productName . 
                    '</h1>';
            
            $sql = "
            SELECT
              AVG(value) AS rating
            FROM
              rating
            WHERE
              productID = $productId
            ";
            
            $result = $conn->query($sql);

            $row = $result->fetch_assoc();

            $rating = $row['rating'];

            echo '<div class="ratings">
                        <div class="rating">';
            
            for ($i = 1; $i <= 5; $i++) {
              if ($i <= floor($rating)) {
                echo '<span class="star">&#9733;</span>';
              } elseif ($i == ceil($rating) && $rating - floor($rating) >= 0.5) {
                echo '<span class="star half-filled">&#9733;</span>';
              } else {
                echo '<span class="star">&#9734;</span>';
              }
            }

            echo '<div class="rating-value">' . round($rating, 1) . '/5</div>
                          </div>
                          <div class="rating-container">
                            <button class="rating-toggle" onclick="toggleRating()">Rate this product</button>
                            <div class="rating-dropdown" id="ratingDropdown">
                              <div class="select-rating" id="rating">
                                <span class="select-star" data-value="1">&#9734;</span>
                                <span class="select-star" data-value="2">&#9734;</span>
                                <span class="select-star" data-value="3">&#9734;</span>
                                <span class="select-star" data-value="4">&#9734;</span>
                                <span class="select-star" data-value="5">&#9734;</span>
                              </div>
                              <p>Selected Rating: <span id="selected-rating">0</span></p>
                              
                              <form id="ratingForm">
                                <input type="hidden" name="rating" id="ratingValue" value="0">
                                <input type="hidden" name="productId" value="' . $productId . '">
                                <button type="button" onclick="submitRating()">Submit Rating</button>
                              </form>
                            </div>
                        </div>
                    </div>
                    <div class="size-selector">';

            $sql = "
              SELECT
                size,
                quantity
              FROM
                product_quantity
              WHERE
                product_id = $productId
            ";

            $result = $conn->query($sql);

            while ($row = $result->fetch_assoc()) {
              $size = $row["size"];
              $quantity = $row["quantity"];
              $class = ($quantity == 0) ? 'out-of-stock' : 'in-stock';

              echo '<div class="size-option ' . $class . '" data-size="' . $size . '" data-quantity="' . $quantity . '">'
                      . $size . 
                    '</div>';
            }

            echo '</div>

                    <div class="product-buttons">
                        <form id="addToCartForm" action="addtocart.php" method="POST">
                          <input type="hidden" id="selected-size" name="size" value="" />
                          <input type="hidden" name="productId" value="' . $productId . '">
                          <label for="quantity">Quantity:</label>
                          <input type="number" name="quantity" id="quantity" value="1" min="1" max="99">
                          <button class="add-to-cart">
                              <img src="img/shopping-cart.svg" alt="Cart" class="cart-icon">
                              ADD to Cart
                          </button>
                        </form>
                        <form id="addToWishlistForm" class="add-to-wishlist-form" action="addtowishlist.php" method="POST">
                          <input type="hidden" id="selected-size-wishlist" name="size" value="" />
                          <input type="hidden" name="productId" value="' . $productId . '">
                          <button class="add-to-wishlist">
                              <img src="img/heart-2.svg" alt="Cart" class="cart-icon">
                              ADD to Wishlist
                          </button>
                        </form>
                    </div>
                    <div class="price-container">Rs. '
                        . $productPrice . 
                    '</div>
                    <div class="reviews-container">
                        <button class="toggle-reviews" onclick="toggleReviews()">Show/Hide Reviews</button>
                        
                        <div class="reviews" id="reviews" style="display: none;">
                            <div class="review-list" id="reviewList">';

            $sql = "
            SELECT
              review.date,
              review.time,
              review.description,
              customer.cusName
            FROM
              review
            LEFT JOIN customer ON review.cusID = customer.cusID
            WHERE
              review.productID = $productId
            ";

            $result = $conn->query($sql);

            while ($row = $result->fetch_assoc()) {
              echo '<div class="review-container">
                      <div class="review-header">
                          <strong>' . ($row["cusName"] !== null ? htmlspecialchars($row["cusName"]) : 'User') . '</strong>
                      </div>
                      <div class="review-body">
                          <p>' . htmlspecialchars($row["description"]) . '</p>
                      </div>
                      <div class="review-footer">
                          Posted on ' . htmlspecialchars($row["date"]) . ' at ' . htmlspecialchars($row["time"]) . '
                      </div>
                    </div>';
            }
            echo '</div>
                            
                    <h2>Add a Review</h2>
                      <form id="reviewForm">
                          <textarea id="reviewText" rows="4" placeholder="Write your review here..." required></textarea>
                          <input type="hidden" name="productId" value="' . $productId . '">
                          <input type="hidden" name="cusId" value="' . $_SESSION['user']['cusID'] . '">
                          <button type="button" onclick="submitReview()">Submit Review</button>
                      </form>
                    </div>
                </div>
              </div>';
          echo '</ul>';
        } else {
              echo "Product not found.";
        }

        $conn->close();
        ?>

</div>

<script src="product-details.js"></script>
<script src="https://unpkg.com/swiper/swiper-bundle.min.js"></script>
<script>
    var swiper = new Swiper('.swiper-container', {
        navigation: {
            nextEl: '.swiper-button-next',
            prevEl: '.swiper-button-prev',
        },
        loop: true,
    });
</script>

</body>
</html>
